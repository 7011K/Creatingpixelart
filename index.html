<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .container { max-width: 700px; margin: auto; }
    .progress { width: 100%; background: #eee; border-radius: 3px; }
    .bar { background: #4caf50; height: 16px; border-radius: 3px; width: 0%; }
    .file-list { font-size: 0.9em; color: #555; margin-bottom: 1em; }
    .preview-area { margin-top: 1em; }
    #previewImage { border:1px solid #ccc; max-width:400px; max-height:400px; display:block; }
    .button-row { margin-bottom: 1em; }
    .locked { pointer-events: none; opacity: 0.5; }
    #loginStatus { color: #d32f2f; margin-bottom: 1em; }
    #loginNotice { font-size: 0.9em; color: #333; margin-bottom: 1em; }
    #customLoginBtn { padding: 0.5em 1em; font-size: 1em; }

    .ad-box {
      position: fixed;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 0.5em;
      font-size: 0.9em;
      color: #333;
      z-index: 999;
      width: 120px;
      max-height: 240px;
      overflow: auto;
    }
    .ad-box.left { top: 100px; left: 10px; }
    .ad-box.right { top: 100px; right: 10px; }
    .ad-box.top { top: 0; left: 0; right: 0; text-align: center; }
    .ad-box.bottom { bottom: 0; left: 0; right: 0; text-align: center; }

    @media screen and (max-width: 600px) {
      .ad-box.left, .ad-box.right { display: none; }
      .ad-box.top, .ad-box.bottom { display: block; padding: 0.5em; }
    }

    @media screen and (min-width: 601px) {
      .ad-box.top, .ad-box.bottom { display: none; }
      .ad-box.left, .ad-box.right { display: block; }
    }
  </style>

  <!-- LinkSwitch ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒãƒªãƒ¥ãƒ¼ã‚³ãƒãƒ¼ã‚¹ï¼‰ -->
  <script type="text/javascript">
    var vc_pid = "3754584";  // â† ã‚ãªãŸã®ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒãƒ¼ã‚¹IDã«å·®ã—æ›¿ãˆã¦ã­ï¼
  </script>
  <script type="text/javascript" src="//aml.valuecommerce.com/vcdal.js" async></script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- åºƒå‘Šã‚¨ãƒªã‚¢ -->
  <div id="leftAd" class="ad-box left"></div>
  <div id="rightAd" class="ad-box right"></div>
  <div id="topAd" class="ad-box top"></div>
  <div id="bottomAd" class="ad-box bottom"></div>

  <div id="loginNotice">
    æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€Google APIã‚’é€šã˜ã¦å–å¾—ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŠã‚ˆã³ä¸æ­£åˆ©ç”¨é˜²æ­¢ã®ãŸã‚å†…éƒ¨ã®ç¦æ­¢ãƒªã‚¹ãƒˆã¨ç…§åˆã—ã¾ã™ã€‚<br>
    ã“ã®ç…§åˆã¯ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨å¯å¦ã®åˆ¤æ–­ã®ã¿ã«ä½¿ç”¨ã•ã‚Œã€ä»–ã®ç›®çš„ã«ã¯åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚<br>
    å–å¾—ã—ãŸæƒ…å ±ã¯å®‰å…¨ã«ä¿ç®¡ã—ã€ç¬¬ä¸‰è€…ã«æä¾›ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¤ã§ã‚‚æƒ…å ±ã®å‰Šé™¤ã‚’ä¾é ¼ã§ãã¾ã™ã€‚<br>
    æœ¬ã‚µã‚¤ãƒˆã«ã¯é‹å–¶è²»ç”¨è£œåŠ©ã®ãŸã‚åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€å–å¾—ã—ãŸæƒ…å ±ã¯åºƒå‘Šé…ä¿¡ã«ã¯åˆ©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚
  </div>
  <div id="loginStatus">Googleãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
  <button id="customLoginBtn" disabled>Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>

  <div class="container locked" id="mainContainer">
    <h1>ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</h1>
    <div class="button-row">
      <button id="infoBtn">èª¬æ˜ã‚’è¡¨ç¤º</button>
      <button id="termsBtn">åˆ©ç”¨è¦ç´„</button>
    </div>

    <label>ãƒ–ãƒ¬ãƒ³ãƒ‰ç‡ (0.0ï½1.0):</label><br>
    <input id="blendRatio" type="range" min="0" max="1" step="0.01" value="0.5" style="width:300px;">
    <span id="blendRatioVal">0.5</span>
    <br><br>

    <label>
      <input id="mixBackground" type="checkbox">
      èƒŒæ™¯ï¼ˆRGBA=(0, 0, 0, 0)ï¼‰ã‚’ãƒŸãƒƒã‚¯ã‚¹å¯¾è±¡ã«ã™ã‚‹
    </label><br>
    <label>
      <input id="useFolder" type="checkbox">
      ç´ æç”»åƒã‚’ãƒ•ã‚©ãƒ«ãƒ€å†…ç”»åƒå…¨ã¦å¯¾è±¡ã«ã™ã‚‹
    </label><br><br>

    <label>å…ƒç”»åƒã‚’é¸æŠï¼ˆæœ€å¤§500Ã—500ï¼‰: 
      <input id="baseImage" type="file" accept="image/*">
    </label>
    <div class="file-list" id="baseFileName"></div>
    <div id="materialInput">
      <label>ç´ æç”»åƒã‚’é¸æŠï¼ˆæœ€å¤§50Ã—50ï¼‰: 
        <input id="materialImage" type="file" accept="image/*">
      </label>
      <div class="file-list" id="materialFileName"></div>
    </div>
    <div id="materialFolderInput" style="display:none;">
      <label>ç´ æç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ: 
        <input id="materialFolder" type="file" accept="image/*" multiple>
      </label>
      <div class="file-list" id="materialFolderFileNames"></div>
    </div>
    <br>

    <button id="generateBtn">ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆã‚’ç”Ÿæˆ</button><br>
    <div class="progress" id="progressBar" style="display:none;"><div class="bar" id="progressBarBar"></div></div>
    <a id="downloadLink" style="display:none;" download="output_image.png">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    <br>
    <div class="preview-area">
      <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <img id="previewImage" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ" style="display:none;">
    </div>
  </div>

  <script type="module">
    import { setupGoogleLogin, userEmail } from './auth.js';
    import { blendColors, getImageDataFromImg, generatePixelArt } from './pixelart.js';

    // LinkSwitchå¯¾å¿œï¼šé€šå¸¸ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
    const adList = [
      { title: "ğŸ¨ Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°", url: "https://shopping.yahoo.co.jp/" },
      { title: "ğŸ“š æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹", url: "https://books.rakuten.co.jp/" },
      { title: "ğŸ§© Amazonãƒˆãƒƒãƒ—", url: "https://www.amazon.co.jp/" }
    ];

    function pickRandomAd() {
      const ad = adList[Math.floor(Math.random() * adList.length)];
      return `<a href="${ad.url}" target="_blank" rel="noopener noreferrer">${ad.title}</a>`;
    }

    document.getElementById("leftAd").innerHTML = pickRandomAd();
    document.getElementById("rightAd").innerHTML = pickRandomAd();
    document.getElementById("topAd").innerHTML = pickRandomAd();
    document.getElementById("bottomAd").innerHTML = pickRandomAd();

    // Googleã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã£ã¦ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    window.onload = () => {
      const waitForGoogle = setInterval(() => {
        if (window.google && window.google.accounts) {
          clearInterval(waitForGoogle);
          document.getElementById("customLoginBtn").disabled = false;
        }
      }, 100);
    };

    // Googleèªè¨¼ï¼ˆBANåˆ¤å®šå«ã‚€ï¼‰
   document.getElementById("customLoginBtn").onclick = () => {
  setupGoogleLogin((email) => {
    if (email) {
      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã®å‡¦ç†
      document.getElementById("loginStatus").textContent = "ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: " + email;
      document.getElementById("mainContainer").classList.remove("locked");
      document.getElementById("customLoginBtn").style.display = "none";
      document.getElementById("loginNotice").style.display = "none";
    } else {
      // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼ˆBANã•ã‚Œã¦ã„ã‚‹ï¼‰æ™‚ã®å‡¦ç†
      document.getElementById("loginStatus").textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆBANã•ã‚Œã¦ã„ã¾ã™ï¼‰";
      document.getElementById("mainContainer").classList.add("locked"); // ãƒ­ãƒƒã‚¯ã‚’ç¶­æŒ
      document.getElementById("customLoginBtn").style.display = "block"; // ãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºã—ãŸã¾ã¾
      document.getElementById("loginNotice").style.display = "block";   // æ³¨æ„æ–‡ã‚‚è¡¨ç¤ºã—ãŸã¾ã¾
    }
  });
};


    // UIã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('blendRatio').addEventListener('input', function() {
      document.getElementById('blendRatioVal').textContent = this.value;
    });
    document.getElementById('useFolder').addEventListener('change', function() {
      const useFolder = document.getElementById('useFolder').checked;
      document.getElementById('materialInput').style.display = useFolder ? 'none' : '';
      document.getElementById('materialFolderInput').style.display = useFolder ? '' : 'none';
    });
    document.getElementById('baseImage').addEventListener('change', () => showFileName('baseImage', 'baseFileName'));
    document.getElementById('materialImage').addEventListener('change', () => showFileName('materialImage', 'materialFileName'));
    document.getElementById('materialFolder').addEventListener('change', () => showFileName('materialFolder', 'materialFolderFileNames'));
    document.getElementById('infoBtn').onclick = showInformation;
    document.getElementById('termsBtn').onclick = showTerms;

    function showFileName(inputId, labelId) {
      const input = document.getElementById(inputId);
      const label = document.getElementById(labelId);
      if (input.files.length === 0) {
        label.textContent = '';
      } else if (input.files.length === 1) {
        label.textContent = `é¸æŠãƒ•ã‚¡ã‚¤ãƒ«: ${input.files[0].name}`;
      } else {
        label.textContent = `é¸æŠãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${input.files.length}`;
        let names = '';
        for (let i = 0; i < input.files.length; i++) {
          names += input.files[i].name + ', ';
        }
        label.textContent += ' (' + names.slice(0,-2) + ')';
      }
    }

    function showInformation() {
      alert(
        `ğŸ“Œ ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦

æœ¬ã‚¢ãƒ—ãƒªã¯é¸æŠã—ãŸå…ƒç”»åƒã®è‰²ã‚’è§£æã—ç´ æç”»åƒã‚’å¤‰æ›´ã—ã¦ä¸¦ã¹ã‚‹ã“ã¨ã§ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã‚‚ã®ã§ã™

ãƒ»å…ƒç”»åƒã¯æœ€å¤§500Ã—500ã€ç´ æç”»åƒã¯æœ€å¤§50Ã—50ãƒ”ã‚¯ã‚»ãƒ«ã¾ã§ã§ã™
ãƒ»GitHub Pagesã§å…¬é–‹ã—ã¦ã‚‚ã€é¸æŠã—ãŸç”»åƒã¯PCã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã€å¤–éƒ¨é€ä¿¡ã•ã‚Œã¾ã›ã‚“
ãƒ»ç´ æç”»åƒã‚µã‚¤ã‚ºã¯æ­£æ–¹å½¢æ¨å¥¨ã§ã™
ãƒ»è¤‡æ•°ç´ æç”»åƒã‚’ä½¿ã†å ´åˆã¯ã€ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„

ç”Ÿæˆå¾Œã€ã€Œç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒªãƒ³ã‚¯ã‹ã‚‰ä¿å­˜ã§ãã¾ã™ã€‚
ç”Ÿæˆç”»åƒã¯ä¸‹éƒ¨ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆå¤§ãã„ç”»åƒã¯ç¸®å°è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰ã€‚`
      );
    }

    function showTerms() {
      alert(
        `ğŸ“œåˆ©ç”¨è¦ç´„

ã“ã‚Œã‚‰ãŒå®ˆã‚‰ã‚Œã¦ã„ãªã„å ´åˆè£½ä½œè€…ã«ã‚ˆã‚‹åˆ©ç”¨åœæ­¢æªç½®ã‚’è¡Œã„ã¾ã™ã®ã§ã”æ³¨æ„ä¸‹ã•ã„

ãƒ»ã‚³ãƒ¼ãƒ‰ã®è§£æã‚„ã‚¢ãƒ—ãƒªã‚’ä½¿ã£ãŸæœ‰æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½œæˆã¯ç¦æ­¢ã§ã™
ãƒ»æœ¬ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã—ã¦ç”Ÿæˆã—ãŸç”»åƒã®è‘—ä½œæ¨©ã¯ä½¿ç”¨ã—ãŸç”»åƒã®è£½ä½œè€…ã«ä¾å­˜ã—ã¾ã™
ãƒ»ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®è²©å£²ã¯ç¦æ­¢ã§ã™
ãƒ»ç”Ÿæˆã•ã‚ŒãŸç”»åƒã¯SNSã§ã®å…¬é–‹ã€ã‚¢ã‚¤ã‚³ãƒ³ã§ã®ä½¿ç”¨ã®ã¿è¨±å¯ã—ã¾ã™ã€€
ã€€â€»ç”»åƒå…¬é–‹ã®éš›ã¯æœ¬ã‚¢ãƒ—ãƒªã®URLã‚’ä¹—ã›ã¦ãã ã•ã„
ãƒ»ç”Ÿæˆã•ã‚ŒãŸç”»åƒã«é–¢ã—ã¦ã®ãƒˆãƒ©ãƒ–ãƒ«ã«ã¯ä¸€åˆ‡ã‹ã‹ã‚ã‚Šã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„`
      );
    }

    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    function showPreview(canvas) {
      const preview = document.getElementById('previewImage');
      const maxW = 800, maxH = 800;
      let scale = Math.min(maxW / canvas.width, maxH / canvas.height, 1);
      let previewW = Math.floor(canvas.width * scale), previewH = Math.floor(canvas.height * scale);
      const thumbCanvas = document.createElement('canvas');
      thumbCanvas.width = previewW;
      thumbCanvas.height = previewH;
      const ctx = thumbCanvas.getContext('2d');
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(canvas, 0, 0, previewW, previewH);
      preview.src = thumbCanvas.toDataURL('image/png');
      preview.style.display = '';
    }

    document.getElementById('generateBtn').onclick = async function () {
      const blendRatio = parseFloat(document.getElementById('blendRatio').value);
      const mixBackground = document.getElementById('mixBackground').checked;
      const useFolder = document.getElementById('useFolder').checked;
      const baseFile = document.getElementById('baseImage').files[0];
      if (!baseFile) return alert('å…ƒç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');

      let materialFiles = [];
      if (useFolder) {
        materialFiles = Array.from(document.getElementById('materialFolder').files);
        if (materialFiles.length === 0) return alert('ç´ æç”»åƒãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
      } else {
        const materialFile = document.getElementById('materialImage').files[0];
        if (!materialFile) return alert('ç´ æç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        materialFiles = [materialFile];
      }

      let baseImg, materialImgs;
      try {
        baseImg = await loadImage(baseFile);
        materialImgs = await Promise.all(materialFiles.map(loadImage));
      } catch (e) {
        return alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const progressBar = document.getElementById('progressBar');
      const progressBarBar = document.getElementById('progressBarBar');
      progressBar.style.display = '';
      progressBarBar.style.width = '0%';

      try {
        const outputCanvas = await generatePixelArt(
          baseImg, materialImgs, blendRatio, mixBackground,
          (percent) => { progressBarBar.style.width = percent + '%'; },
          userEmail
        );
        progressBar.style.display = 'none';
        const url = outputCanvas.toDataURL('image/png');
        const link = document.getElementById('downloadLink');
        link.href = url;
        link.style.display = '';
        showPreview(outputCanvas);
        alert('ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚');
      } catch (e) {
        progressBar.style.display = 'none';
        alert(e.message || 'ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
  </script>
</body>
</html>

